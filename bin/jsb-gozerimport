#!/usr/bin/env python
#
#

""" convert gozerbot pickled data to jsonbot. """

## boot

import os, sys
sys.path.insert(0, os.getcwd())

## jsb imports

from jsb.utils.generic import sedfile, sedstring
from jsb.utils.exception import handle_exception
from jsb.lib.persist import Persist
from jsb.lib.config import Config

## basic imports

import os
import pickle

## convert function

def convert(source, target):
    for file in os.listdir(source):
        if file in ['seen', 'away', 'idle', 'rss.itemslist']: continue
        try:
            f = sedfile(source + os.sep + file, "s/cgozerbot/cjsb.compat/")
            f = sedstring(f.getvalue(), "s/cmyplugs/cjsb.compat/")
            obj = pickle.loads(f)
            if file.endswith("-config"):
                d = {}
                for key, option in obj.iteritems():
                    d[key] = option.value
                print d
                c = Config(file, ddir=target, input=d)
                c.tofile(target + os.sep + file)
            else:
                p = Persist(target + os.sep + file)
                try:
                    p.data = obj
                    p.save()
                except:
                    try:
                        d = {}
                        for i,j in obj.iteritems():
                            try: d[str(i)] = str(j)
                            except: continue
                        p.data = d
                        p.save()
                    except:
                        r = []
                        for i in obj:
                            try: r.append(str(i))
                            except: continue
                        p.data = r
                        p.save()
        except Exception, ex: print "ERROR: %s - %s" % (source + os.sep + file, str(ex))

try:
    convert(sys.argv[1], sys.argv[2])
except IndexError: print "jsb-gozerimport <gozerdata dir> <output dir>"