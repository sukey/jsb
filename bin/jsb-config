#!/usr/bin/env python
#
#

""" edit jsb config files. """

## json imports

from jsb.imports import getjson
json = getjson()

## basic imports

import logging

## bootstrap

import warnings  
warnings.simplefilter("ignore")

import os, sys
sys.path.insert(0, os.getcwd())

## command line parsing

from jsb.version import getversion

from optparse import OptionParser
parser = OptionParser(usage='usage: %prog [options] <appid>', version='%prog ' + getversion())
parser.add_option('-d', '--datadir', type='string', default=False, dest='datadir', help="datadir to use")
parser.add_option('-l', '--loglevel', type='string', default=False, dest='loglevel', help="logging level")
parser.add_option('', '--colors', action="store_true", default=False, dest='colors', help="enable the use of colors")
opts, args = parser.parse_args()
opts.args = args

if opts.datadir:
    if not os.path.isdir(opts.datadir): os.mkdir(opts.datadir)
    from jsb.lib.datadir import setdatadir
    setdatadir(opts.datadir)

## make config from cmndline options

from jsb.utils.log import setloglevel   
from jsb.lib.config import getmainconfig
mainconfig = getmainconfig()
setloglevel(opts.loglevel or "error", opts.colors)

from jsb.version import getversion
print getversion('CONFIG')

from jsb.utils.log import setloglevel
setloglevel("error")

if len(opts.args) == 0:
    print "you can choose one of the following:\n\t"
    from jsb.lib.datadir import getdatadir
    for botname in os.listdir(getdatadir() + os.sep + 'config' + os.sep + 'fleet'):
        print "\t%s" % botname
    print "jsb-config <botname>"   
    os._exit(1)

## edit the config file

from jsb.lib.datadir import getdatadir

botname = opts.args[0]
configfile = getdatadir() + os.sep + "config" + os.sep + "fleet" + os.sep + botname + os.sep + "config"
if os.path.isdir(configfile):
    print "available - %s" % os.listdir(configfile)
    os._exit(1)

try:
    from jsb.lib.config import Config
    cfg = Config(configfile)
except Exception, ex:
    print "can't make config from file %s - %s" % (configfile, str(ex))
    os._exit(1)

try:
    attr = sys.argv[3]
    value = sys.argv[4]
    cfg[attr] = json.loads(value)
except IndexError, ex: print "no values to set"
except TypeError, ex:
    print u"can't parse %s - %s" % (unicode(value), unicode(ex))
    os._exit(1)
else:
    cfg.save()
    print "%s of %s set to %s" % (attr, configfile, value)

print cfg.dump()
